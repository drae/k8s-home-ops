# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/helm.toolkit.fluxcd.io/helmrelease_v2.json
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: wrtag
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  values:
    controllers:
      wrtag:
        pod:
          securityContext:
            runAsNonRoot: true
            runAsUser: 2000
            runAsGroup: 2000
            fsGroup: 2000
            fsGroupChangePolicy: OnRootMismatch
            seccompProfile:
              type: RuntimeDefault
        containers:
          app:
            nameOverride: wrtag
            image:
              repository: ghcr.io/sentriz/wrtag
              tag: v0.18.0@sha256:b31ed97f5573ab9a141046135da9c80d30d0601ab47dadb02408a136e94d621f
            env:
              WRTAG_WEB_LISTEN_ADDR: ":80"
              WRTAG_WEB_PUBLIC_URL: https://wrtag.p.lan.starstreak.net
              WRTAG_WEB_DB_PATH: /data/wrtag.db
              WRTAG_LOG_LEVEL: debug
              WRTAG_PATH_FORMAT: '/media/music/{{`{{ artists .Release.Artists | sort | join "; " | safepath }}/{{ .Release.Title | safepath }}{{ if not (eq .ReleaseDisambiguation "") }} ({{ .ReleaseDisambiguation | safepath }}){{ end }} ({{ .Release.ReleaseGroup.FirstReleaseDate.Year }})/{{ pad0 2 .TrackNum }} {{ .Track.Title | safepath }}{{ .Ext }}`}}'
            envFrom:
              - secretRef:
                  name: wrtag-secret
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL
            resources:
              requests:
                cpu: 10m
                memory: 128Mi
              limits:
                memory: 256Mi
    service:
      app:
        controller: wrtag
        ports:
          http:
            port: &port 80
    route:
      app:
        hostnames:
          - wrtag.p.lan.starstreak.net
        parentRefs:
          - name: internal
            namespace: networking
            sectionName: https
        rules:
          - backendRefs:
              - identifier: app
                port: *port
    persistence:
      data:
        existingClaim: wrtag-config
      media:
        type: nfs
        server: 10.1.10.10
        path: /mnt/zstore/media
        globalMounts:
          - path: /media/.downloads/soulseek
            subPath: .downloads/soulseek
          - path: /media/music
            subPath: music
      tmp:
        type: emptyDir
