---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: unifi
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  values:
    controllers:
      unifi:
        pod:
          securityContext:
            runAsNonRoot: true
            runAsUser: 999
            runAsGroup: 999
            fsGroup: 999
            fsGroupChangePolicy: "OnRootMismatch"
        containers:
          app:
            image:
              repository: ghcr.io/goofball222/unifi
              tag: v9.5@sha256:c29b19bf750fcc964a8e30c3d29baea9bc9f35b58abc88ec9e1e8e007a0dadbf
            env:
              UNIFI_DB_NAME: unifi
              JVM_MAX_HEAP_SIZE: 1024M
              RUN_CHOWN: "false"
              TZ: Europe/London
            resources:
              requests:
                memory: 1Gi
                cpu: 50m
              limits:
                memory: 1250Mi
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities:
                drop:
                  - ALL
    service:
      app:
        type: LoadBalancer
        annotations:
          lbipam.cilium.io/ips: 10.1.10.36
        externalTrafficPolicy: Cluster
        ports:
          https:
            port: &port 8443
            protocol: HTTPS
            primary: true
          controller:
            enabled: true
            port: 8080
            protocol: TCP
          speedtest:
            enabled: true
            port: 6789
            protocol: TCP
          stun:
            enabled: true
            port: 3478
            protocol: UDP
          syslog:
            enabled: true
            port: 5514
            protocol: UDP
          discovery:
            enabled: true
            port: 10001
            protocol: UDP
#    route:
#      app:
#        hostnames:
#          - unifi.p.lan.starstreak.net
#        parentRefs:
#          - name: internal
#            namespace: networking
#            sectionName: https
#        rules:
#          - backendRefs:
#              - identifier: app
#                port: *port
#            timeouts:
#              request: 0s # websocket, never time out
#              backendRequest: 0s # websocket, never time out
    persistence:
      data:
        existingClaim: unifi-config
        globalMounts:
          - path: /usr/lib/unifi/data
          - path: /usr/lib/unifi/cert
      logs:
        type: emptyDir
        globalMounts:
          - path: /usr/lib/unifi/logs
      cert:
        type: secret
        name: p-lan-starstreak-net-unifi
        advancedMounts:
          unifi:
            app:
              - path: /usr/lib/unifi/cert/cert.pem
                subPath: tls.crt
                readOnly: true
              - path: /usr/lib/unifi/cert/privkey.pem
                subPath: tls.key
                readOnly: true
              - path: /usr/lib/unifi/cert/keystore
                subPath: keystore.jks
                readOnly: false
