---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  PYTHON_BIN: python3
  ANSIBLE_DIR: "{{.INFRASTRUCTURE_DIR}}/ansible"
  ANSIBLE_PLAYBOOK: "{{.PROJECT_DIR}}/.venv/bin/ansible-playbook"
  INVENTORY: "{{.ANSIBLE_DIR}}/inventory/hosts.yml"

env:
  PATH: "{{.PROJECT_DIR}}/.venv/bin:$PATH"
  VIRTUAL_ENV: "{{.PROJECT_DIR}}/.venv"
  ANSIBLE_COLLECTIONS_PATH: "{{.PROJECT_DIR}}/.venv/galaxy"
  ANSIBLE_ROLES_PATH: "{{.ANSIBLE_DIR}}/roles:{{.PROJECT_DIR}}/.venv/galaxy/ansible_roles"
  ANSIBLE_VARS_ENABLED: "host_group_vars"

tasks:
  venv:
    desc: Set up Python virtual environment
    cmds:
      - "{{.PYTHON_BIN}} -m venv {{.PROJECT_DIR}}/.venv"
      - "{{.PROJECT_DIR}}/.venv/bin/python3 -m pip install --upgrade pip setuptools wheel"
      - "{{.PROJECT_DIR}}/.venv/bin/python3 -m pip install --upgrade --requirement {{.ANSIBLE_DIR}}/requirements.txt"
      - "{{.PROJECT_DIR}}/.venv/bin/ansible-galaxy install --role-file {{.ANSIBLE_DIR}}/requirements.yml --force"
    sources:
      - "{{.ANSIBLE_DIR}}/requirements.txt"
      - "{{.ANSIBLE_DIR}}/requirements.yml"
    generates:
      - "{{.PROJECT_DIR}}/.venv/pyvenv.cfg"

  run:
    desc: Run Ansible playbook for a machine
    prompt: Run '{{.playbook}}' on '{{.machine}}'?
    cmd: "{{.ANSIBLE_PLAYBOOK}} -i {{.INVENTORY}} {{.ANSIBLE_DIR}}/playbooks/{{.machine}}/{{.playbook}}.yml {{.CLI_ARGS}}"
    requires:
      vars: [machine, playbook]
    preconditions:
      - test -d {{.PROJECT_DIR}}/.venv
      - test -f {{.INVENTORY}}
      - test -f {{.ANSIBLE_DIR}}/playbooks/{{.machine}}/{{.playbook}}.yml

  site:
    desc: Run complete site playbook
    prompt: Run site playbook on all machines?
    cmd: "{{.ANSIBLE_PLAYBOOK}} -i {{.INVENTORY}} {{.ANSIBLE_DIR}}/playbooks/site.yml {{.CLI_ARGS}}"
    preconditions:
      - test -d {{.PROJECT_DIR}}/.venv
      - test -f {{.INVENTORY}}
      - test -f {{.ANSIBLE_DIR}}/playbooks/site.yml

  common:
    desc: Run common OS and Docker setup
    prompt: Run common setup on all machines?
    cmd: |
      {{.ANSIBLE_PLAYBOOK}} -i {{.INVENTORY}} {{.ANSIBLE_DIR}}/playbooks/common/os.yml {{.CLI_ARGS}} &&
      {{.ANSIBLE_PLAYBOOK}} -i {{.INVENTORY}} {{.ANSIBLE_DIR}}/playbooks/common/docker.yml {{.CLI_ARGS}}
    preconditions:
      - test -d {{.PROJECT_DIR}}/.venv
      - test -f {{.INVENTORY}}
      - test -f {{.ANSIBLE_DIR}}/playbooks/common/os.yml
      - test -f {{.ANSIBLE_DIR}}/playbooks/common/docker.yml
