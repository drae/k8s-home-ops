---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  PYTHON_BIN: python3

env:
  PATH: "{{.PROJECT_DIR}}/.venv/bin:$PATH"
  VIRTUAL_ENV: "{{.PROJECT_DIR}}/.venv"
  ANSIBLE_COLLECTIONS_PATH: "{{.PROJECT_DIR}}/.venv/galaxy"
  ANSIBLE_ROLES_PATH: "{{.PROJECT_DIR}}/.venv/galaxy/ansible_roles"
  ANSIBLE_VARS_ENABLED: "host_group_vars"

tasks:
  venv:
    desc: Set up Python virtual environment
    cmds:
      - true && {{.PYTHON_BIN}} -m venv {{.PROJECT_DIR}}/.venv
      - true && {{.PROJECT_DIR}}/.venv/bin/python3 -m pip install --upgrade pip setuptools wheel
      - true && {{.PROJECT_DIR}}/.venv/bin/python3 -m pip install --upgrade --requirement {{.INFRASTRUCTURE_DIR}}/ansible/requirements.txt
      - true && {{.PROJECT_DIR}}/.venv/bin/ansible-galaxy install --role-file "{{.INFRASTRUCTURE_DIR}}/ansible/requirements.yml" --force
    sources:
      - "{{.INFRASTRUCTURE_DIR}}/ansible/requirements.txt"
      - "{{.INFRASTRUCTURE_DIR}}/ansible/requirements.yml"
    generates:
      - "{{.PROJECT_DIR}}/.venv/pyvenv.cfg"

  run:
    desc: Run an Ansible playbook for configuring a cluster
    summary: |
      Args:
        machine: Machine to run command against (required)
        playbook: Playbook to run (required)
    prompt: Run Ansible playbook '{{.playbook}}' against the 'apollo' cluster ... continue?
    cmd: |
      true && {{.PROJECT_DIR}}/.venv/bin/ansible-playbook --inventory {{.INFRASTRUCTURE_DIR}}/ansible/apollo/inventory/hosts.yml \
        {{.INFRASTRUCTURE_DIR}}/ansible/{{.machine}}/playbooks/{{.playbook}}.yml {{.CLI_ARGS}}
    requires:
      vars:
        - machine
        - playbook
    preconditions:
      - test -d {{.PROJECT_DIR}}/.venv
      - test -f {{.INFRASTRUCTURE_DIR}}/ansible/{{.machine}}/inventory/hosts.yml
      - test -f {{.INFRASTRUCTURE_DIR}}/ansible/{{.machine}}/playbooks/{{.playbook}}.yml
