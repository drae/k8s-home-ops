---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  DOPPLER_PROJECT: talos

tasks:
  genconfig:
    desc: Generate clusterconfig for Talos
    silent: true
    cmds:
      - doppler run -p {{.DOPPLER_PROJECT}} -- talhelper genconfig
        --secret-file {{.INFRASTRUCTURE_DIR}}/talos/darkstar/talsecret.yaml
        --config-file {{.INFRASTRUCTURE_DIR}}/talos/darkstar/talconfig.yaml
        --out-dir {{.INFRASTRUCTURE_DIR}}/talos/darkstar/clusterconfig
    preconditions:
      - which doppler talhelper
      - test -f {{.INFRASTRUCTURE_DIR}}/talos/darkstar/talsecret.yaml
      - test -f {{.INFRASTRUCTURE_DIR}}/talos/darkstar/talconfig.yaml

  applyconfig:
    desc: Apply clusterconfig for a Talos cluster
    vars:
      CLUSTERCONFIG_FILES:
        sh: find {{.INFRASTRUCTURE_DIR}}/talos/darkstar/clusterconfig -type f -name '*.yaml' -printf '%f\n'
    cmds:
      - for:
          var: CLUSTERCONFIG_FILES
        task: _apply-machineconfig
        vars:
          filename: "{{.ITEM}}"
          hostname: |-
            {{ trimPrefix (printf "%s-" "darkstar") .ITEM | trimSuffix ".yaml" }}
    preconditions:
      - talosctl config get-contexts | grep darkstar
      - test -d {{.INFRASTRUCTURE_DIR}}/talos/darkstar/clusterconfig

  kubeconfig:
    desc: Generate kubeconfig for a Talos cluster
    preconditions:
      - which talosctl
      - test -f "${TALOSCONFIG}"
    silent: true
    dir: "{{ .TALOS_DIR }}"
    cmds:
      - talosctl kubeconfig

  reset:
    desc: Reset a node to maintenance mode
    silent: true
    prompt: "Reset node {{ .HOSTNAME }}?"
    preconditions:
      - which talosctl
      - test -f "${TALOSCONFIG}"
    requires:
      vars:
        - HOSTNAME
    cmds:
      - talosctl reset --graceful=false -n {{ .HOSTNAME }} --reboot

  upgrade-node:
    desc: Upgrade Talos on a single node [NODE=required]
    dir: "{{ .TALOS_DIR }}"
    preconditions:
      - which talosctl
      - test -f "${TALOSCONFIG}"
      - talosctl --nodes {{ .NODE }} get machineconfig
    requires:
      vars:
        - NODE
    vars:
      FILE:
        sh: ls clusterconfig/darkstar-{{ .NODE }}*.yaml
      TALOS_IMAGE:
        sh: yq '.machine.install.image' < "{{ .FILE }}"
    cmds:
      - talosctl --nodes {{ .NODE }} upgrade --image="{{ .TALOS_IMAGE }}" --timeout=10m
      - talosctl --nodes {{ .NODE }} health

  _apply-machineconfig:
    internal: true
    desc: Apply a single Talos machineConfig to a Talos node
    cmds:
      - talosctl --context darkstar apply-config
        --nodes "{{.hostname}}"
        --file "{{.INFRASTRUCTURE_DIR}}/talos/darkstar/clusterconfig/{{.filename}}"
        --mode="{{.MODE}}"
        {{ if eq "true" .INSECURE }}--insecure{{ end }}
        {{ if eq "true" .DRY_RUN }}--dry-run{{ end }}
    preconditions:
      - talosctl config get-contexts | grep darkstar
      - test -f {{.INFRASTRUCTURE_DIR}}/talos/darkstar/clusterconfig/{{.filename}}
    requires:
      vars:
        - hostname
        - filename
    vars:
      MODE: '{{.MODE | default "auto"}}'
